<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Layanan Data Individu</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        pre { background: #eee; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { background-color: #007bff; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 5px; margin-bottom: 5px; }
        button:hover { background-color: #0056b3; }
        .data-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .action-buttons button { margin: 0 2px; padding: 5px 8px; font-size: 12px; }
        .form-section { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
        .form-section label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-section input[type="text"], .form-section input[type="number"], .form-section input[type="date"], .form-section select {
            width: calc(100% - 20px);
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-section button { margin-top: 10px; }
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
        }
        #detail-container {
            display:none;
            position:fixed;
            top:10%;
            left:50%;
            transform:translate(-50%, 0);
            background:white;
            padding:20px;
            border-radius:8px;
            box-shadow:0 4px 8px rgba(0,0,0,0.2);
            z-index:1000;
            min-width:300px;
            max-height: 80vh;
            overflow-y: auto;
        }
        #detail-container h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        #detail-container ul {
            list-style: none;
            padding: 0;
        }
        #detail-container ul li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard Layanan Data Individu</h1>
        <p>Aplikasi ini menampilkan data dari GraphQL API.</p>

        <hr>

        <h2>Data Tenaga Kesehatan</h2>
        <button onclick="fetchData('allTenagaKesehatan')">Muat Semua Tenaga Kesehatan</button>
        <button onclick="showForm('tenagaKesehatanForm', 'add')">Tambah Tenaga Kesehatan Baru</button>
        <div id="tenagaKesehatanData" class="data-section"></div>

        <div id="tenagaKesehatanForm" class="form-section" style="display: none;">
            <h3><span id="tk_formTitle">Tambah</span> Tenaga Kesehatan</h3>
            <input type="hidden" id="tk_id_nakes">
            <label for="tk_nip">NIP:</label>
            <input type="text" id="tk_nip" required>
            <label for="tk_role">Role:</label>
            <input type="text" id="tk_role" required>
            <label for="tk_str">STR:</label>
            <input type="text" id="tk_str" required>
            <button onclick="submitTenagaKesehatanForm()">Simpan</button>
            <button onclick="hideForm('tenagaKesehatanForm')">Batal</button>
        </div>

        <hr>

        <h2>Data Pasien</h2>
        <button onclick="fetchData('allPasien')">Muat Semua Pasien</button>
        <button onclick="showForm('pasienForm', 'add')">Tambah Pasien Baru</button>
        <div id="pasienData" class="data-section"></div>

        <div id="pasienForm" class="form-section" style="display: none;">
            <h3><span id="pasien_formTitle">Tambah</span> Pasien</h3>
            <input type="hidden" id="pasien_id_pasien">
            <label for="pasien_nik">NIK:</label>
            <input type="text" id="pasien_nik" required>
            <label for="pasien_nama_lengkap">Nama Lengkap:</label>
            <input type="text" id="pasien_nama_lengkap" required>
            <label for="pasien_jenis_kelamin">Jenis Kelamin:</label>
            <select id="pasien_jenis_kelamin" required>
                <option value="">Pilih</option>
                <option value="L">Laki-laki</option>
                <option value="P">Perempuan</option>
            </select>
            <label for="pasien_tanggal_lahir">Tanggal Lahir:</label>
            <input type="date" id="pasien_tanggal_lahir" required>
            <label for="pasien_no_bpjs">No BPJS (Opsional):</label>
            <input type="text" id="pasien_no_bpjs">
            <label for="pasien_pekerjaan">Pekerjaan:</label>
            <input type="text" id="pasien_pekerjaan" required>
            <label for="pasien_status_pernikahan">Status Pernikahan:</label>
            <select id="pasien_status_pernikahan" required>
                <option value="">Pilih</option>
                <option value="Belum Menikah">Belum Menikah</option>
                <option value="Menikah">Menikah</option>
                <option value="Cerai">Cerai</option>
            </select>
            <button onclick="submitPasienForm()">Simpan</button>
            <button onclick="hideForm('pasienForm')">Batal</button>
        </div>

        <hr>

        <h2>Data Dokter</h2>
        <button onclick="fetchData('allDokter')">Muat Semua Dokter</button>
        <button onclick="showForm('dokterForm', 'add')">Tambah Dokter Baru</button>
        <div id="dokterData" class="data-section"></div>

        <div id="dokterForm" class="form-section" style="display: none;">
            <h3><span id="dokter_formTitle">Tambah</span> Dokter</h3>
            <input type="hidden" id="dokter_id_dokter">
            <label for="dokter_id_nakes">ID Nakes:</label>
            <input type="number" id="dokter_id_nakes" required>
            <label for="dokter_nip">NIP:</label>
            <input type="text" id="dokter_nip" required>
            <label for="dokter_nama_dokter">Nama Dokter:</label>
            <input type="text" id="dokter_nama_dokter" required>
            <label for="dokter_status">Status:</label>
            <input type="text" id="dokter_status" required>
            <label for="dokter_str">STR:</label>
            <input type="text" id="dokter_str" required>
            <label for="dokter_spesialisasi">Spesialisasi:</label>
            <input type="text" id="dokter_spesialisasi" required>
            <label for="dokter_no_hp">No HP:</label>
            <input type="text" id="dokter_no_hp" required>
            <button onclick="submitDokterForm()">Simpan</button>
            <button onclick="hideForm('dokterForm')">Batal</button>
        </div>

        <hr>

        <h2>Data Perawat</h2>
        <button onclick="fetchData('allPerawat')">Muat Semua Perawat</button>
        <button onclick="showForm('perawatForm', 'add')">Tambah Perawat Baru</button>
        <div id="perawatData" class="data-section"></div>

        <div id="perawatForm" class="form-section" style="display: none;">
            <h3><span id="perawat_formTitle">Tambah</span> Perawat</h3>
            <input type="hidden" id="perawat_id_perawat">
            <label for="perawat_id_nakes">ID Nakes:</label>
            <input type="number" id="perawat_id_nakes" required>
            <label for="perawat_nip">NIP:</label>
            <input type="text" id="perawat_nip" required>
            <label for="perawat_nama_perawat">Nama Perawat:</label>
            <input type="text" id="perawat_nama_perawat" required>
            <label for="perawat_status">Status:</label>
            <input type="text" id="perawat_status" required>
            <label for="perawat_str">STR:</label>
            <input type="text" id="perawat_str" required>
            <label for="perawat_spesialisasi">Spesialisasi:</label>
            <input type="text" id="perawat_spesialisasi" required>
            <label for="perawat_no_hp">No HP:</label>
            <input type="text" id="perawat_no_hp" required>
            <button onclick="submitPerawatForm()">Simpan</button>
            <button onclick="hideForm('perawatForm')">Batal</button>
        </div>
    </div>

    <div id="detail-container"></div>
    <div id="modal-overlay" onclick="hideDetail()"></div>

    <script>
        const API_URL = 'http://localhost:8000'; 

        
        function showForm(formId, mode = 'add', data = {}) {
            const form = document.getElementById(formId);
            let formTitleElement;

            
            if (formId === 'tenagaKesehatanForm') {
                formTitleElement = document.getElementById('tk_formTitle');
            } else if (formId === 'pasienForm') {
                formTitleElement = document.getElementById('pasien_formTitle');
            } else if (formId === 'dokterForm') {
                formTitleElement = document.getElementById('dokter_formTitle');
            } else if (formId === 'perawatForm') {
                formTitleElement = document.getElementById('perawat_formTitle');
            }

            if (!formTitleElement) {
                console.error(`Form title element not found for formId: ${formId}`);
                return; /
            }

            form.style.display = 'block';
            console.log(`showForm called for ${formId} in ${mode} mode with data:`, data); 

            if (mode === 'add') {
                formTitleElement.textContent = 'Tambah';
                
                if (formId === 'tenagaKesehatanForm') {
                    document.getElementById('tk_id_nakes').value = '';
                    document.getElementById('tk_nip').value = '';
                    document.getElementById('tk_role').value = '';
                    document.getElementById('tk_str').value = '';
                } else if (formId === 'pasienForm') {
                    document.getElementById('pasien_id_pasien').value = '';
                    document.getElementById('pasien_nik').value = '';
                    document.getElementById('pasien_nama_lengkap').value = '';
                    document.getElementById('pasien_jenis_kelamin').value = ''; // Set to empty for "Pilih"
                    document.getElementById('pasien_tanggal_lahir').value = '';
                    document.getElementById('pasien_no_bpjs').value = '';
                    document.getElementById('pasien_pekerjaan').value = '';
                    document.getElementById('pasien_status_pernikahan').value = '';
                } else if (formId === 'dokterForm') {
                    document.getElementById('dokter_id_dokter').value = '';
                    document.getElementById('dokter_id_nakes').value = '';
                    document.getElementById('dokter_nip').value = '';
                    document.getElementById('dokter_nama_dokter').value = '';
                    document.getElementById('dokter_status').value = '';
                    document.getElementById('dokter_str').value = '';
                    document.getElementById('dokter_spesialisasi').value = '';
                    document.getElementById('dokter_no_hp').value = '';
                } else if (formId === 'perawatForm') {
                    document.getElementById('perawat_id_perawat').value = '';
                    document.getElementById('perawat_id_nakes').value = '';
                    document.getElementById('perawat_nip').value = '';
                    document.getElementById('perawat_nama_perawat').value = '';
                    document.getElementById('perawat_status').value = '';
                    document.getElementById('perawat_str').value = '';
                    document.getElementById('perawat_spesialisasi').value = '';
                    document.getElementById('perawat_no_hp').value = '';
                }
            } else if (mode === 'edit') {
                formTitleElement.textContent = 'Edit';
                // Isi form fields dengan data yang ada berdasarkan formId
                if (formId === 'tenagaKesehatanForm') {
                    document.getElementById('tk_id_nakes').value = data.id_nakes || '';
                    document.getElementById('tk_nip').value = data.nip || '';
                    document.getElementById('tk_role').value = data.role || '';
                    document.getElementById('tk_str').value = data.str || '';
                    console.log("Tenaga Kesehatan form fields populated for edit:", {
                        id_nakes: document.getElementById('tk_id_nakes').value,
                        nip: document.getElementById('tk_nip').value,
                        role: document.getElementById('tk_role').value,
                        str: document.getElementById('tk_str').value
                    }); // DEBUG
                } else if (formId === 'pasienForm') {
                    document.getElementById('pasien_id_pasien').value = data.id_pasien || '';
                    document.getElementById('pasien_nik').value = data.nik || '';
                    document.getElementById('pasien_nama_lengkap').value = data.nama_lengkap || '';
                    
                    // --- PERUBAHAN UTAMA DI SINI UNTUK JENIS KELAMIN SAAT EDIT ---
                    // Karena select option value-nya adalah 'L' atau 'P', kita bisa langsung assign
                    document.getElementById('pasien_jenis_kelamin').value = data.jenis_kelamin || '';
                    // --- AKHIR PERUBAHAN ---

                    // Tanggal lahir perlu diformat ulang jika dari DB dalam format berbeda (misal YYYY-MM-DD HH:MM:SS)
                    document.getElementById('pasien_tanggal_lahir').value = data.tanggal_lahir ? data.tanggal_lahir.split(' ')[0] : ''; // Menggunakan split(' ') untuk memisahkan tanggal dari waktu
                    document.getElementById('pasien_no_bpjs').value = data.no_bpjs || '';
                    document.getElementById('pasien_pekerjaan').value = data.pekerjaan || '';
                    document.getElementById('pasien_status_pernikahan').value = data.status_pernikahan || '';
                    console.log("Pasien form fields populated for edit:", {
                        id_pasien: document.getElementById('pasien_id_pasien').value,
                        nik: document.getElementById('pasien_nik').value,
                        nama_lengkap: document.getElementById('pasien_nama_lengkap').value,
                        jenis_kelamin: document.getElementById('pasien_jenis_kelamin').value,
                        tanggal_lahir: document.getElementById('pasien_tanggal_lahir').value,
                        no_bpjs: document.getElementById('pasien_no_bpjs').value,
                        pekerjaan: document.getElementById('pasien_pekerjaan').value,
                        status_pernikahan: document.getElementById('pasien_status_pernikahan').value
                    }); // DEBUG
                } else if (formId === 'dokterForm') {
                    document.getElementById('dokter_id_dokter').value = data.id_dokter || '';
                    document.getElementById('dokter_id_nakes').value = data.id_nakes || '';
                    document.getElementById('dokter_nip').value = data.nip || '';
                    document.getElementById('dokter_nama_dokter').value = data.nama_dokter || '';
                    document.getElementById('dokter_status').value = data.status || '';
                    document.getElementById('dokter_str').value = data.str || '';
                    document.getElementById('dokter_spesialisasi').value = data.spesialisasi || '';
                    document.getElementById('dokter_no_hp').value = data.no_hp || '';
                    console.log("Dokter form fields populated for edit:", {
                        id_dokter: document.getElementById('dokter_id_dokter').value,
                        id_nakes: document.getElementById('dokter_id_nakes').value,
                        nip: document.getElementById('dokter_nip').value,
                        nama_dokter: document.getElementById('dokter_nama_dokter').value,
                        status: document.getElementById('dokter_status').value,
                        str: document.getElementById('dokter_str').value,
                        spesialisasi: document.getElementById('dokter_spesialisasi').value,
                        no_hp: document.getElementById('dokter_no_hp').value
                    }); // DEBUG
                } else if (formId === 'perawatForm') {
                    document.getElementById('perawat_id_perawat').value = data.id_perawat || '';
                    document.getElementById('perawat_id_nakes').value = data.id_nakes || '';
                    document.getElementById('perawat_nip').value = data.nip || '';
                    document.getElementById('perawat_nama_perawat').value = data.nama_perawat || '';
                    document.getElementById('perawat_status').value = data.status || '';
                    document.getElementById('perawat_str').value = data.str || '';
                    document.getElementById('perawat_spesialisasi').value = data.spesialisasi || '';
                    document.getElementById('perawat_no_hp').value = data.no_hp || '';
                    console.log("Perawat form fields populated for edit:", {
                        id_perawat: document.getElementById('perawat_id_perawat').value,
                        id_nakes: document.getElementById('perawat_id_nakes').value,
                        nip: document.getElementById('perawat_nip').value,
                        nama_perawat: document.getElementById('perawat_nama_perawat').value,
                        status: document.getElementById('perawat_status').value,
                        str: document.getElementById('perawat_str').value,
                        spesialisasi: document.getElementById('perawat_spesialisasi').value,
                        no_hp: document.getElementById('perawat_no_hp').value
                    }); // DEBUG
                }
            }
        }

        function hideForm(formId) {
            document.getElementById(formId).style.display = 'none';
        }

        // Fungsi utama untuk mengambil data (query)
        async function fetchData(entity) {
            let query = '';
            let targetElementId = '';
            let fields = '';

            switch (entity) {
                case 'allTenagaKesehatan':
                    fields = `id_nakes nip role str`;
                    targetElementId = 'tenagaKesehatanData';
                    break;
                case 'allPasien':
                    fields = `id_pasien nik nama_lengkap jenis_kelamin tanggal_lahir no_bpjs pekerjaan status_pernikahan`;
                    targetElementId = 'pasienData';
                    break;
                case 'allDokter':
                    fields = `id_dokter id_nakes nip nama_dokter status str spesialisasi no_hp`;
                    targetElementId = 'dokterData';
                    break;
                case 'allPerawat':
                    fields = `id_perawat id_nakes nip nama_perawat status str spesialisasi no_hp`;
                    targetElementId = 'perawatData';
                    break;
                default:
                    console.error('Entity not recognized');
                    return;
            }

            query = `query { ${entity} { ${fields} } }`;
            console.log("Fetching data with query:", query); // DEBUG

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query }),
                });

                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await response.text();
                    const dataContainer = document.getElementById(targetElementId);
                    dataContainer.innerHTML = `<p style="color: red;">Error: Server response was not JSON. Raw response: <pre>${text}</pre></p>`;
                    console.error("Server responded with non-JSON content:", text);
                    return;
                }

                const result = await response.json();
                const dataContainer = document.getElementById(targetElementId);

                console.log("GraphQL response for", entity, ":", result); // DEBUG

                if (result.errors) {
                    dataContainer.innerHTML = `<p style="color: red;">Error: ${result.errors[0].message}</p>`;
                    console.error("GraphQL Errors:", result.errors);
                } else if (result.data) {
                    const data = result.data[entity];
                    if (data && data.length > 0) {
                        console.log("Data received for rendering:", data); // DEBUG
                        renderTable(data, dataContainer, entity); // Panggil fungsi renderTable
                    } else {
                        dataContainer.innerHTML = `<p>Tidak ada data ${entity.replace('all', '')} ditemukan.</p>`;
                    }
                } else {
                    dataContainer.innerHTML = `<p>Tidak ada data yang diterima dari API.</p>`;
                }
            } catch (error) {
                const dataContainer = document.getElementById(targetElementId);
                dataContainer.innerHTML = `<p style="color: red;">Fetch error: ${error.message}</p>`;
                console.error("Fetch Error:", error);
            }
        }

        // Fungsi untuk merender tabel dengan tombol aksi
        function renderTable(data, containerElement, entity) {
            if (!data || data.length === 0) {
                containerElement.innerHTML = `<p>Tidak ada data untuk ditampilkan.</p>`;
                return;
            }

            const headers = Object.keys(data[0]);
            let tableHtml = '<table><thead><tr>';
            headers.forEach(header => {
                tableHtml += `<th>${header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`;
            });
            tableHtml += `<th>Aksi</th></tr></thead><tbody>`;

            data.forEach(row => {
                tableHtml += '<tr>';
                headers.forEach(header => {
                    // Penanganan khusus untuk tanggal agar tampil lebih rapi
                    if (header.includes('tanggal_lahir') && row[header]) {
                        const date = new Date(row[header]);
                        tableHtml += `<td>${date.toLocaleDateString('id-ID')}</td>`; // Format tanggal sesuai lokal Indonesia
                    } else if (header === 'jenis_kelamin' && row[header]) {
                        // Tampilkan 'Laki-laki' atau 'Perempuan' di tabel
                        tableHtml += `<td>${row[header] === 'L' ? 'Laki-laki' : (row[header] === 'P' ? 'Perempuan' : row[header])}</td>`;
                    }
                    else {
                        tableHtml += `<td>${row[header] !== null ? row[header] : 'N/A'}</td>`;
                    }
                });
                tableHtml += `<td class="action-buttons">`;
                
                const encodedRowData = btoa(JSON.stringify(row));
                console.log("Row to encode for", entity, ":", row, "Encoded:", encodedRowData); // DEBUG

                tableHtml += `<button onclick="editEntity('${entity}', '${encodedRowData}')">Edit</button>`;
                tableHtml += `<button onclick="deleteEntity('${entity}', ${row[idFieldName(entity)]})">Delete</button>`;
                tableHtml += `<button onclick="showDetail('${entity}', '${encodedRowData}')">Detail</button>`;
                tableHtml += `</td></tr>`;
            });
            tableHtml += '</tbody></table>';
            containerElement.innerHTML = tableHtml;
        }

        // --- Fungsi untuk Mutasi (Tambah, Edit, Delete) ---

        // Fungsi submit untuk Tenaga Kesehatan
        async function submitTenagaKesehatanForm() {
            const id_nakes_val = document.getElementById('tk_id_nakes').value;
            const nip = document.getElementById('tk_nip').value;
            const role = document.getElementById('tk_role').value;
            const str = document.getElementById('tk_str').value;

            if (!nip || !role || !str) {
                alert('Semua field (NIP, Role, STR) harus diisi.');
                return;
            }

            let mutation = '';
            let variables = {};
            let mutationName = '';

            if (id_nakes_val) {
                mutationName = 'updateTenagaKesehatan';
                mutation = `
                    mutation UpdateTenagaKesehatan($id_nakes: Int!, $nip: String, $role: String, $str: String) {
                        updateTenagaKesehatan(id_nakes: $id_nakes, nip: $nip, role: $role, str: $str) {
                            id_nakes
                            nip
                            role
                            str
                        }
                    }
                `;
                variables = { id_nakes: parseInt(id_nakes_val), nip, role, str };
            } else {
                mutationName = 'createTenagaKesehatan';
                mutation = `
                    mutation CreateTenagaKesehatan($nip: String!, $role: String!, $str: String!) {
                        createTenagaKesehatan(nip: $nip, role: $role, str: $str) {
                            id_nakes
                            nip
                            role
                            str
                        }
                    }
                `;
                variables = { nip, role, str };
            }

            console.log(`Submitting mutation ${mutationName} with variables:`, variables); // DEBUG

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: mutation, variables: variables }),
                });

                const result = await response.json();
                console.log("Mutation response:", result); // DEBUG

                if (result.errors) {
                    alert('Error: ' + result.errors[0].message);
                    console.error("GraphQL Mutation Error:", result.errors);
                } else if (result.data && result.data[mutationName]) {
                    alert(`Data Tenaga Kesehatan ${mutationName === 'createTenagaKesehatan' ? 'Ditambahkan' : 'Diperbarui'} berhasil!`);
                    hideForm('tenagaKesehatanForm');
                    fetchData('allTenagaKesehatan'); // Refresh data setelah operasi
                } else {
                    alert(`Operasi ${mutationName} berhasil, namun tidak ada data yang dikembalikan atau nama mutasi tidak ditemukan dalam respons data.`);
                    console.log("Mutation success with no specific return data or unexpected structure:", result);
                    hideForm('tenagaKesehatanForm');
                    fetchData('allTenagaKesehatan');
                }
            } catch (error) {
                alert('Fetch error: ' + error.message);
                console.error("Fetch Error during mutation:", error);
            }
        }

        // Fungsi submit untuk Pasien
        async function submitPasienForm() {
            const id_pasien_val = document.getElementById('pasien_id_pasien').value;
            const nik = document.getElementById('pasien_nik').value;
            const nama_lengkap = document.getElementById('pasien_nama_lengkap').value;
            // LANGSUNG AMBIL NILAI 'L' atau 'P' dari select
            const jenis_kelamin = document.getElementById('pasien_jenis_kelamin').value; 
            const tanggal_lahir = document.getElementById('pasien_tanggal_lahir').value;
            const no_bpjs = document.getElementById('pasien_no_bpjs').value;
            const pekerjaan = document.getElementById('pasien_pekerjaan').value;
            const status_pernikahan = document.getElementById('pasien_status_pernikahan').value;

            // Validasi sederhana
            if (!nik || !nama_lengkap || !jenis_kelamin || !tanggal_lahir || !pekerjaan || !status_pernikahan) {
                alert('Semua field wajib (NIK, Nama Lengkap, Jenis Kelamin, Tanggal Lahir, Pekerjaan, Status Pernikahan) harus diisi.');
                return;
            }
            if (jenis_kelamin === '') { // Pastikan 'Pilih' tidak terpilih
                alert('Jenis Kelamin harus dipilih.');
                return;
            }
            if (status_pernikahan === '') { // Pastikan 'Pilih' tidak terpilih
                alert('Status Pernikahan harus dipilih.');
                return;
            }

            let mutation = '';
            let variables = {};
            let mutationName = '';

            if (id_pasien_val) { // Mode Edit Pasien
                mutationName = 'updatePasien';
                mutation = `
                    mutation UpdatePasien(
                        $id_pasien: Int!, $nik: String, $nama_lengkap: String,
                        $jenis_kelamin: String, $tanggal_lahir: String, $no_bpjs: String,
                        $pekerjaan: String, $status_pernikahan: String
                    ) {
                        updatePasien(
                            id_pasien: $id_pasien, nik: $nik, nama_lengkap: $nama_lengkap,
                            jenis_kelamin: $jenis_kelamin, tanggal_lahir: $tanggal_lahir, no_bpjs: $no_bpjs,
                            pekerjaan: $pekerjaan, status_pernikahan: $status_pernikahan
                        ) {
                            id_pasien
                        }
                    }
                `;
                variables = {
                    id_pasien: parseInt(id_pasien_val), nik, nama_lengkap,
                    jenis_kelamin, tanggal_lahir, no_bpjs, pekerjaan, status_pernikahan
                };
            } else { // Mode Tambah Pasien
                mutationName = 'createPasien';
                mutation = `
                    mutation CreatePasien(
                        $nik: String!, $nama_lengkap: String!,
                        $jenis_kelamin: String!, $tanggal_lahir: String!, $no_bpjs: String,
                        $pekerjaan: String!, $status_pernikahan: String!
                    ) {
                        createPasien(
                            nik: $nik, nama_lengkap: $nama_lengkap,
                            jenis_kelamin: $jenis_kelamin, tanggal_lahir: $tanggal_lahir, no_bpjs: $no_bpjs,
                            pekerjaan: $pekerjaan, status_pernikahan: $status_pernikahan
                        ) {
                            id_pasien
                        }
                    }
                `;
                variables = {
                    nik, nama_lengkap, jenis_kelamin, tanggal_lahir,
                    no_bpjs: no_bpjs === '' ? null : no_bpjs, // Kirim null jika kosong untuk opsional
                    pekerjaan, status_pernikahan
                };
            }

            console.log(`Submitting Pasien mutation ${mutationName} with variables:`, variables);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: mutation, variables: variables }),
                });

                const result = await response.json();
                console.log("Pasien mutation response:", result);

                if (result.errors) {
                    alert('Error: ' + result.errors[0].message);
                    console.error("GraphQL Pasien Mutation Error:", result.errors);
                } else if (result.data && result.data[mutationName]) {
                    alert(`Data Pasien ${mutationName === 'createPasien' ? 'Ditambahkan' : 'Diperbarui'} berhasil!`);
                    hideForm('pasienForm');
                    fetchData('allPasien'); // Refresh data pasien setelah operasi
                } else {
                    alert(`Operasi ${mutationName} Pasien berhasil, namun tidak ada data yang dikembalikan atau nama mutasi tidak ditemukan dalam respons data.`);
                    console.log("Pasien Mutation success with no specific return data or unexpected structure:", result);
                    hideForm('pasienForm');
                    fetchData('allPasien');
                }
            } catch (error) {
                alert('Fetch error: ' + error.message);
                console.error("Fetch Error during Pasien mutation:", error);
            }
        }

        // Fungsi submit untuk Dokter
        async function submitDokterForm() {
            const id_dokter = document.getElementById('dokter_id_dokter').value;
            const idNakes = document.getElementById('dokter_id_nakes').value;
            const nip = document.getElementById('dokter_nip').value;
            const namaDokter = document.getElementById('dokter_nama_dokter').value;
            const status = document.getElementById('dokter_status').value;
            const str = document.getElementById('dokter_str').value;
            const spesialisasi = document.getElementById('dokter_spesialisasi').value;
            const noHp = document.getElementById('dokter_no_hp').value;

            let mutation = '';
            let variables = {};
            let mutationName = '';

            if (id_dokter) {
                mutationName = 'updateDokter';
                mutation = `
                    mutation UpdateDokter(
                        $id_dokter: Int!, $idNakes: Int, $nip: String, $namaDokter: String,
                        $status: String, $str: String, $spesialisasi: String, $noHp: String
                    ) {
                        updateDokter(
                            id_dokter: $id_dokter, idNakes: $idNakes, nip: $nip, namaDokter: $namaDokter,
                            status: $status, str: $str, spesialisasi: $spesialisasi, noHp: $noHp
                        ) {
                            id_dokter
                        }
                    }
                `;
                variables = { id_dokter: parseInt(id_dokter), idNakes: parseInt(idNakes), nip, namaDokter, status, str, spesialisasi, noHp };
            } else {
                mutationName = 'createDokter';
                mutation = `
                    mutation CreateDokter(
                        $idNakes: Int!, $nip: String!, $namaDokter: String!, $status: String!,
                        $str: String!, $spesialisasi: String!, $noHp: String!
                    ) {
                        createDokter(
                            idNakes: $idNakes, nip: $nip, namaDokter: $namaDokter, status: $status,
                            str: $str, spesialisasi: $spesialisasi, noHp: $noHp
                        ) {
                            id_dokter
                        }
                    }
                `;
                variables = { idNakes: parseInt(idNakes), nip, namaDokter, status, str, spesialisasi, noHp };
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: mutation, variables: variables }),
                });

                const result = await response.json();
                if (result.errors) {
                    alert('Error: ' + result.errors[0].message);
                } else if (result.data && result.data[mutationName]) {
                    alert(`Data Dokter ${mutationName === 'createDokter' ? 'Ditambahkan' : 'Diperbarui'} berhasil!`);
                    hideForm('dokterForm');
                    fetchData('allDokter');
                }
            } catch (error) {
                alert('Fetch error: ' + error.message);
            }
        }

        // Fungsi submit untuk Perawat
        async function submitPerawatForm() {
            const id_perawat_val = document.getElementById('perawat_id_perawat').value;
            const idNakes = document.getElementById('perawat_id_nakes').value;
            const nip = document.getElementById('perawat_nip').value;
            const namaPerawat = document.getElementById('perawat_nama_perawat').value;
            const status = document.getElementById('perawat_status').value;
            const str = document.getElementById('perawat_str').value;
            const spesialisasi = document.getElementById('perawat_spesialisasi').value;
            const noHp = document.getElementById('perawat_no_hp').value;

            if (!idNakes || !nip || !namaPerawat || !status || !str || !spesialisasi || !noHp) {
                alert('Semua field (ID Nakes, NIP, Nama Perawat, Status, STR, Spesialisasi, No HP) harus diisi.');
                return;
            }

            let mutation = '';
            let variables = {};
            let mutationName = '';

            if (id_perawat_val) {
                mutationName = 'updatePerawat';
                mutation = `
                    mutation UpdatePerawat(
                        $id_perawat: Int!, $idNakes: Int!, $nip: String, $namaPerawat: String,
                        $status: String, $str: String, $spesialisasi: String, $noHp: String
                    ) {
                        updatePerawat(
                            id_perawat: $id_perawat, idNakes: $idNakes, nip: $nip, namaPerawat: $namaPerawat,
                            status: $status, str: $str, spesialisasi: $spesialisasi, noHp: $noHp
                        ) {
                            id_perawat
                            nip
                            namaPerawat
                            status
                            str
                            spesialisasi
                            noHp
                        }
                    }
                `;
                variables = {
                    id_perawat: parseInt(id_perawat_val),
                    idNakes: parseInt(idNakes),
                    nip,
                    namaPerawat,
                    status,
                    str,
                    spesialisasi,
                    noHp
                };
            } else {
                mutationName = 'createPerawat';
                mutation = `
                    mutation CreatePerawat(
                        $idNakes: Int!, $nip: String!, $namaPerawat: String!,
                        $status: String!, $str: String!, $spesialisasi: String!, $noHp: String!
                    ) {
                        createPerawat(
                            idNakes: $idNakes, nip: $nip, namaPerawat: $namaPerawat,
                            status: $status, str: $str, spesialisasi: $spesialisasi, noHp: $noHp
                        ) {
                            id_perawat
                            nip
                            namaPerawat
                            status
                            str
                            spesialisasi
                            noHp
                        }
                    }
                `;
                variables = {
                    idNakes: parseInt(idNakes),
                    nip,
                    namaPerawat,
                    status,
                    str,
                    spesialisasi,
                    noHp
                };
            }

            console.log(`Submitting Perawat mutation ${mutationName} with variables:`, variables); 

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: mutation, variables: variables }),
                });

                const result = await response.json();
                console.log("Perawat mutation response:", result); 

                if (result.errors) {
                    alert('Error: ' + result.errors[0].message);
                    console.error("GraphQL Perawat Mutation Error:", result.errors);
                } else if (result.data && result.data[mutationName]) {
                    alert(`Data Perawat ${mutationName === 'createPerawat' ? 'Ditambahkan' : 'Diperbarui'} berhasil!`);
                    hideForm('perawatForm');
                    fetchData('allPerawat');
                } else {
                    alert(`Operasi ${mutationName} berhasil, namun tidak ada data yang dikembalikan atau nama mutasi tidak ditemukan dalam respons data.`);
                    console.log("Perawat Mutation success with no specific return data or unexpected structure:", result);
                    hideForm('perawatForm');
                    fetchData('allPerawat');
                }
            } catch (error) {
                alert('Fetch error: ' + error.message);
                console.error("Fetch Error during Perawat mutation:", error);
            }
        }

        
        function editEntity(entity, encodedData) {
            console.log("editEntity called. Entity:", entity, "Encoded Data:", encodedData); 
            try {
                const data = JSON.parse(atob(encodedData)); 
                console.log("Decoded data for edit:", data); 

                if (entity === 'allTenagaKesehatan') {
                    showForm('tenagaKesehatanForm', 'edit', data);
                } else if (entity === 'allPasien') {
                    showForm('pasienForm', 'edit', data);
                } else if (entity === 'allDokter') {
                    showForm('dokterForm', 'edit', data);
                } else if (entity === 'allPerawat') {
                    showForm('perawatForm', 'edit', data);
                }
            } catch (e) {
                console.error("Error decoding or parsing data in editEntity:", e);
                alert("Failed to load data for editing. Check console for details.");
            }
        }

        
        async function deleteEntity(entity, id) {
            if (!confirm(`Apakah Anda yakin ingin menghapus data ${entity.replace('all', '')} dengan ID ${id}?`)) {
                return;
            }

            let mutation = '';
            let mutationName = '';
            let idField = idFieldName(entity);

            if (entity === 'allTenagaKesehatan') {
                mutationName = 'deleteTenagaKesehatan';
                mutation = `
                    mutation DeleteTenagaKesehatan($${idField}: Int!) {
                        deleteTenagaKesehatan(${idField}: $${idField}) {
                            ${idField}
                        }
                    }
                `;
            } else if (entity === 'allPasien') {
                mutationName = 'deletePasien';
                mutation = `
                    mutation DeletePasien($${idField}: Int!) {
                        deletePasien(${idField}: $${idField}) {
                            ${idField}
                        }
                    }
                `;
            } else if (entity === 'allDokter') {
                mutationName = 'deleteDokter';
                mutation = `
                    mutation DeleteDokter($${idField}: Int!) {
                        deleteDokter(${idField}: $${idField}) {
                            ${idField}
                        }
                    }
                `;
            } else if (entity === 'allPerawat') {
                mutationName = 'deletePerawat';
                mutation = `
                    mutation DeletePerawat($${idField}: Int!) {
                        deletePerawat(${idField}: $${idField}) {
                            ${idField}
                        }
                    }
                `;
            }

            if (!mutation) {
                alert('Operasi delete tidak didukung untuk entitas ini.');
                return;
            }

            console.log(`Submitting delete mutation ${mutationName} for ID: ${id}`); 
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: mutation, variables: { [idField]: id } }),
                });

                const result = await response.json();
                console.log("Delete mutation response:", result); 

                if (result.errors) {
                    alert('Error: ' + result.errors[0].message);
                    console.error("GraphQL Delete Error:", result.errors);
                } else if (result.data && result.data[mutationName]) {
                    alert('Dihapus berhasil!');
                    fetchData(entity); 
                } else {
                    alert(`Operasi ${mutationName} berhasil, namun tidak ada data yang dikembalikan atau nama mutasi tidak ditemukan dalam respons data.`);
                    console.log("Delete success with no specific return data or unexpected structure:", result);
                    fetchData(entity);
                }
            } catch (error) {
                alert('Fetch error: ' + error.message);
                console.error("Fetch Error during delete:", error);
            }
        }

        
        function showDetail(entity, encodedData) {
            console.log("showDetail called. Entity:", entity, "Encoded Data:", encodedData); 
            try {
                const data = JSON.parse(atob(encodedData)); 
                console.log("Decoded data for detail:", data); 

                let detailHtml = `<h3>Detail ${entity.replace('all', '')}</h3>`;
                detailHtml += `<ul>`;
                for (const key in data) {
                 
                    if (key === 'tanggal_lahir' && data[key]) {
                        const date = new Date(data[key]);
                        detailHtml += `<li><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${date.toLocaleDateString('id-ID')}</li>`;
                    } else if (key === 'jenis_kelamin' && data[key]) {
                        
                        detailHtml += `<li><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${data[key] === 'L' ? 'Laki-laki' : (data[key] === 'P' ? 'Perempuan' : data[key])}</li>`;
                    }
                    else {
                        detailHtml += `<li><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${data[key] !== null ? data[key] : 'N/A'}</li>`;
                    }
                }
                detailHtml += `</ul>`;
                detailHtml += `<button onclick="hideDetail()">Tutup</button>`;

                const detailContainer = document.getElementById('detail-container');
                detailContainer.innerHTML = detailHtml;
                detailContainer.style.display = 'block';
                document.getElementById('modal-overlay').style.display = 'block';
            } catch (e) {
                console.error("Error decoding or parsing data in showDetail:", e);
                alert("Failed to load detail data. Check console for details.");
            }
        }

        function hideDetail() {
            document.getElementById('detail-container').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
        }

        
        function idFieldName(entity) {
            switch (entity) {
                case 'allTenagaKesehatan': return 'id_nakes';
                case 'allPasien': return 'id_pasien';
                case 'allDokter': return 'id_dokter';
                case 'allPerawat': return 'id_perawat';
                default: return 'id'; 
            }
        }
    </script>
</body>
</html>